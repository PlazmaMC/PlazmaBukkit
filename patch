#!/bin/sh

COMMAND=$1
shift
COMMIT_MSG="$*"

if [ -z "$COMMAND" ]; then
  echo "Usage: $0 <command> [\"Commit message\"]"
  exit 1
fi

ROOT_DIR=$(pwd)

# Build a single target
build_single() {
  local DIR=$1
  local BUILD_CMD=$2
  cd "$ROOT_DIR/$DIR" || exit
  git add .
  if [ -n "$COMMIT_MSG" ]; then
    git commit -m "$COMMIT_MSG" || echo "No changes to commit in $DIR"
  fi
  cd "$ROOT_DIR" || exit
  ./gradlew "$BUILD_CMD"
}

# Merge a single target
merge_single() {
  local DIR=$1
  local BUILD_CMD=$2
  cd "$ROOT_DIR/$DIR" || exit
  LAST_MSG=$(git log -n 1 --pretty=format:"%s")
  git reset --soft HEAD~1      # 이전 커밋으로 이동
  git add .                    # 모든 변경 사항을 스테이징
  git commit -m "$LAST_MSG"    # 이전 커밋 메시지로 commit
  cd "$ROOT_DIR" || exit
  ./gradlew "$BUILD_CMD"
}

# Build Minecraft server patches (java + resources)
build_minecraft_server() {
  local BUILD_CMD=$1
  for DIR in "plazma-server/src/minecraft/java" "plazma-server/src/minecraft/resources"; do
    cd "$ROOT_DIR/$DIR" || exit
    git add .
    if [ -n "$COMMIT_MSG" ]; then
      git commit -m "$COMMIT_MSG" || echo "No changes to commit in $DIR"
    fi
    cd "$ROOT_DIR" || exit
  done
  ./gradlew "$BUILD_CMD"
}

# Merge Minecraft server patches (java + resources)
merge_minecraft_server() {
  local BUILD_CMD=$1
  for DIR in "plazma-server/src/minecraft/java" "plazma-server/src/minecraft/resources"; do
    cd "$ROOT_DIR/$DIR" || exit
    LAST_MSG=$(git log -n 1 --pretty=format:"%s")
    git reset --soft HEAD~1
    git add .
    git commit -m "$LAST_MSG"
    cd "$ROOT_DIR" || exit
  done
  ./gradlew "$BUILD_CMD"
}

case $COMMAND in
  buildPaperAPI)
    build_single "paper-api" "rebuildPaperApiPatches"
    ;;
  buildPurpurAPI)
    build_single "purpur-api" "rebuildPurpurApiPatches"
    ;;
  buildPaperServer)
    build_single "paper-server" "rebuildPaperServerPatches"
    ;;
  buildPurpurServer)
    build_single "purpur-server" "rebuildPurpurServerPatches"
    ;;
  buildMinecraftServer)
    build_minecraft_server "rebuildMinecraftPatches"
    ;;
  build)
    build_single "paper-api" "rebuildPaperApiPatches"
    build_single "purpur-api" "rebuildPurpurApiPatches"
    build_single "paper-server" "rebuildPaperServerPatches"
    build_single "purpur-server" "rebuildPurpurServerPatches"
    build_minecraft_server "rebuildMinecraftPatches"
    ;;
  mergePaperAPI)
    merge_single "paper-api" "rebuildPaperApiPatches"
    ;;
  mergePurpurAPI)
    merge_single "purpur-api" "rebuildPurpurApiPatches"
    ;;
  mergePaperServer)
    merge_single "paper-server" "rebuildPaperServerPatches"
    ;;
  mergePurpurServer)
    merge_single "purpur-server" "rebuildPurpurServerPatches"
    ;;
  mergeMinecraftServer)
    merge_minecraft_server "rebuildMinecraftPatches"
    ;;
  *)
    echo "Unknown command: $COMMAND"
    exit 1
    ;;
esac
